<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DocScan</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Syne:wght@700;800&display=swap');

    :root {
      --bg:       #071a1e;
      --panel:    #0c2228;
      --surf:     #102830;
      --brd:      #1a3d45;
      --brd2:     #235060;
      --acc:      #2dd4bf;
      --acc2:     #0ea5e9;
      --acc-dim:  #1a7a6e;
      --txt:      #c8e8e4;
      --txt2:     #6a9a94;
      --txt3:     #3a6060;
      --ok:       #2dd4bf;
      --err:      #e05555;
      --r:        6px;
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: var(--bg);
      background-image:
        radial-gradient(ellipse at 15% 0%, #0d4a52 0%, transparent 55%),
        radial-gradient(ellipse at 85% 5%, #063a50 0%, transparent 45%),
        radial-gradient(ellipse at 50% 100%, #041e28 0%, transparent 60%);
      color: var(--txt);
      font-family: 'Inter', sans-serif;
      font-size: 14px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    /* â”€â”€ HEADER â”€â”€ */
    header {
      width: 100%;
      max-width: 780px;
      padding: 2.5rem 0 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .logo {
      font-family: 'Syne', sans-serif;
      font-weight: 800;
      font-size: 1.9rem;
      letter-spacing: -.04em;
      line-height: 1;
      background: linear-gradient(110deg, #2dd4bf 0%, #38bdf8 60%, #7dd3fc 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      position: relative;
    }
    .logo::after {
      content: '';
      position: absolute;
      bottom: -4px; left: 0;
      width: 100%; height: 2px;
      background: linear-gradient(90deg, #2dd4bf, transparent);
      border-radius: 2px;
      opacity: .5;
    }

    .badge {
      font-size: .65rem;
      color: var(--txt3);
      letter-spacing: .06em;
      text-transform: uppercase;
      border: 1px solid var(--brd);
      padding: .3rem .65rem;
      border-radius: 20px;
      background: rgba(13,34,40,.6);
    }

    /* â”€â”€ MAIN â”€â”€ */
    main {
      width: 100%;
      max-width: 780px;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      padding-bottom: 3rem;
    }

    /* â”€â”€ DROP ZONE â”€â”€ */
    #drop {
      border: 1.5px dashed var(--brd2);
      border-radius: var(--r);
      padding: 2.2rem 1.5rem;
      text-align: center;
      cursor: pointer;
      position: relative;
      transition: border-color .2s, background .2s;
      background: var(--panel);
    }
    #drop:hover, #drop.over {
      border-color: var(--acc);
      background: rgba(45,212,191,.04);
    }
    #drop input {
      position: absolute; inset: 0; opacity: 0;
      cursor: pointer; width: 100%; height: 100%;
    }
    .drop-icon {
      width: 36px; height: 36px;
      border: 1.5px solid var(--brd2);
      border-radius: 8px;
      display: flex; align-items: center; justify-content: center;
      margin: 0 auto .8rem;
      color: var(--acc);
      font-size: 1rem;
    }
    .drop-title { font-size: .88rem; font-weight: 500; color: var(--txt); margin-bottom: .3rem; }
    .drop-sub   { font-size: .72rem; color: var(--txt2); }
    .drop-fmt   { margin-top: .5rem; font-size: .62rem; color: var(--txt3); letter-spacing: .08em; text-transform: uppercase; }

    /* â”€â”€ FILE LIST â”€â”€ */
    .files-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .sec-label {
      font-size: .68rem;
      text-transform: uppercase;
      letter-spacing: .08em;
      color: var(--txt3);
      font-weight: 500;
    }
    .btn-clear {
      font-size: .68rem;
      color: var(--txt3);
      background: none;
      border: 1px solid var(--brd);
      border-radius: 4px;
      padding: .2rem .55rem;
      cursor: pointer;
      transition: color .2s, border-color .2s;
      font-family: inherit;
    }
    .btn-clear:hover { color: var(--err); border-color: var(--err); }

    #flist { display: flex; flex-direction: column; gap: .35rem; }

    .fi {
      display: flex; align-items: center; gap: .6rem;
      padding: .55rem .8rem;
      background: var(--panel);
      border: 1px solid var(--brd);
      border-radius: var(--r);
      transition: border-color .3s;
    }
    .fi.loading { border-color: var(--brd); }
    .fi.ready   { border-color: var(--brd2); }
    .fi.error   { border-color: var(--err); }

    .fext {
      font-size: .6rem; font-weight: 600; text-transform: uppercase;
      padding: .15rem .35rem; border-radius: 3px;
      background: var(--surf); color: var(--txt2);
      flex-shrink: 0; min-width: 2.2rem; text-align: center;
      letter-spacing: .04em;
    }
    .fn   { flex: 1; font-size: .78rem; color: var(--txt); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .fs   { font-size: .68rem; flex-shrink: 0; color: var(--txt3); }
    .fs.loading { color: var(--txt3); }
    .fs.ready   { color: var(--ok); }
    .fs.error   { color: var(--err); }
    .fdel {
      background: none; border: none; color: var(--txt3);
      cursor: pointer; font-size: .85rem; flex-shrink: 0;
      transition: color .2s; padding: 0 .1rem; line-height: 1;
    }
    .fdel:hover { color: var(--err); }

    .fpw { padding: 0 .8rem .4rem; }
    .fpb { height: 1.5px; background: var(--brd); border-radius: 1px; overflow: hidden; }
    .fpf { height: 100%; background: var(--acc); width: 0%; transition: width .3s; }
    .fpl { font-size: .58rem; color: var(--txt3); margin-top: .2rem; }

    /* â”€â”€ SEARCH â”€â”€ */
    .search-wrap {
      position: relative;
    }
    .search-icon {
      position: absolute; left: .9rem; top: 50%; transform: translateY(-50%);
      color: var(--txt3); pointer-events: none; font-size: .9rem;
    }
    #q {
      width: 100%;
      background: var(--panel);
      border: 1.5px solid var(--brd2);
      color: var(--txt);
      font-family: inherit; font-size: .92rem;
      padding: .75rem 1rem .75rem 2.4rem;
      border-radius: var(--r);
      outline: none;
      transition: border-color .2s;
    }
    #q:focus { border-color: var(--acc); }
    #q::placeholder { color: var(--txt3); }

    /* â”€â”€ RESULTS â”€â”€ */
    .results-header {
      display: flex; align-items: center; justify-content: space-between;
    }
    #stats { font-size: .68rem; color: var(--txt3); }
    #stats b { color: var(--acc); font-weight: 600; }

    #res { display: flex; flex-direction: column; gap: .5rem; }

    .rc {
      background: var(--panel);
      border: 1px solid var(--brd2);
      border-radius: var(--r);
      overflow: hidden;
      animation: fadein .15s ease;
    }
    @keyframes fadein { from { opacity:0; transform:translateY(2px); } to { opacity:1; } }
    .rc.hit { border-color: var(--acc-dim); }

    .rh {
      display: flex; align-items: center; gap: .6rem;
      padding: .6rem .85rem;
    }
    .rc.hit .rh { border-bottom: 1px solid var(--brd); }
    .rn   { flex: 1; font-size: .8rem; font-weight: 500; color: var(--txt); }
    .rk   {
      font-size: .65rem; background: var(--acc); color: #071a1e;
      padding: .15rem .45rem; border-radius: 3px; font-weight: 600;
    }

    .rss  { padding: .5rem .85rem .65rem; display: flex; flex-direction: column; gap: .4rem; }
    .sn   {
      font-size: .72rem; color: var(--txt2); line-height: 1.65;
      border-left: 2px solid var(--brd2); padding-left: .6rem;
    }
    .sn mark  { background: rgba(45,212,191,.25); color: var(--acc); padding: 0 .1rem; border-radius: 2px; }
    .snp  { font-size: .58rem; color: var(--txt3); margin-bottom: .15rem; text-transform: uppercase; letter-spacing: .05em; }

    /* â”€â”€ EMPTY STATE â”€â”€ */
    .empty {
      text-align: center; padding: 2.5rem 1rem;
      color: var(--txt3); font-size: .78rem; line-height: 2;
    }
    .empty .eico { font-size: 2rem; margin-bottom: .5rem; opacity: .4; }

    /* â”€â”€ SPINNER â”€â”€ */
    .spin {
      display: inline-block; width: 8px; height: 8px;
      border: 1.5px solid var(--brd2); border-top-color: var(--acc);
      border-radius: 50%; animation: sp .5s linear infinite; vertical-align: middle;
    }
    @keyframes sp { to { transform: rotate(360deg); } }

    /* â”€â”€ DEBUG â”€â”€ */
    #dbg { display:none; position:fixed; bottom:0; left:0; right:0; height:200px; background:#020809; border-top:1px solid var(--brd); font-size:.62rem; font-family:monospace; overflow-y:auto; padding:.5rem 1rem; z-index:999; color:var(--txt3); }
    #dbg.on { display:block; }
    #dbg-btn { position:fixed; bottom:6px; right:8px; background:var(--panel); border:1px solid var(--brd); color:var(--txt3); font-size:.58rem; padding:.2rem .45rem; border-radius:3px; cursor:pointer; z-index:1000; font-family:inherit; }
    .dl { padding:.08rem 0; border-bottom:1px solid #0d1a1c; }
    .dl.ok  { color:var(--ok); } .dl.err { color:var(--err); } .dl.info { color:var(--acc); }

    /* â”€â”€ FOOTER â”€â”€ */
    footer {
      width: 100%; max-width: 780px;
      padding: 1rem 0 1.5rem;
      font-size: .62rem; color: var(--txt3);
      border-top: 1px solid var(--brd);
      margin-top: auto;
    }

    @media (max-width: 820px) {
      header, main, footer { padding-left: 1.2rem; padding-right: 1.2rem; }
    }
  </style>
</head>
<body>

<header>
  <div class="logo">DocÂ·Scan</div>
  <div class="badge">100% local Â· aucune donnÃ©e enregistrÃ©e</div>
</header>

<main>

  <!-- DROP -->
  <div id="drop">
    <input type="file" id="fi" multiple accept=".pdf,.png,.jpg,.jpeg,.txt,.csv,.md,.html"/>
    <div class="drop-icon">â†‘</div>
    <div class="drop-title">Glisser les documents ici</div>
    <div class="drop-sub">ou cliquer pour sÃ©lectionner</div>
    <div class="drop-fmt">PDF Â· JPG Â· PNG Â· TXT Â· CSV Â· MD</div>
  </div>

  <!-- FILE LIST -->
  <div class="files-header" id="files-header" style="display:none">
    <span class="sec-label" id="files-count">0 document</span>
    <button class="btn-clear" onclick="clearAll()">Tout supprimer</button>
  </div>
  <div id="flist"></div>

  <!-- SEARCH -->
  <div class="search-wrap">
    <span class="search-icon">âŒ•</span>
    <input id="q" type="text" placeholder="Rechercherâ€¦ ex: poursuite, extincteur, 53600" autocomplete="off" spellcheck="false"/>
  </div>

  <!-- RESULTS -->
  <div class="results-header" id="res-header" style="display:none">
    <span class="sec-label">RÃ©sultats</span>
    <span id="stats"></span>
  </div>
  <div id="res">
    <div class="empty"><div class="eico">?</div>IMPORTEZ DES DOCUMENTS PUIS TAPEZ POUR CHERCHER</div>
  </div>

</main>

<footer>DocScan Â· PDF.js Â· OCR.space Â· traitement local Â· fermez l'onglet pour tout effacer</footer>

<div id="dbg"></div>
<button id="dbg-btn" onclick="document.getElementById('dbg').classList.toggle('on')">debug</button>

<script>
// â”€â”€ Debug â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function log(msg, type='') {
  console.log('[DS]', msg);
  const d = document.getElementById('dbg');
  const l = document.createElement('div');
  l.className = 'dl' + (type ? ' '+type : '');
  l.textContent = new Date().toLocaleTimeString() + ' ' + msg;
  d.appendChild(l);
  d.scrollTop = d.scrollHeight;
}

// â”€â”€ PDF.js â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
pdfjsLib.GlobalWorkerOptions.workerSrc =
  'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const docs = {};
let uid = 0, stmo = null;

// â”€â”€ Drag & drop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const drop = document.getElementById('drop');
const fi   = document.getElementById('fi');
drop.addEventListener('dragover',  e => { e.preventDefault(); drop.classList.add('over'); });
drop.addEventListener('dragleave', ()  => drop.classList.remove('over'));
drop.addEventListener('drop', e => { e.preventDefault(); drop.classList.remove('over'); go(e.dataTransfer.files); });
fi.addEventListener('change', () => { go(fi.files); fi.value = ''; });

// â”€â”€ Load â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function go(files) {
  for (const f of [...files]) {
    const id  = ++uid;
    const ext = f.name.split('.').pop().toLowerCase();
    docs[id]  = { id, name: f.name, ext, text: '', pages: [], status: 'loading', prog: 0, plbl: 'â€¦' };
    log(`ðŸ“„ Fichier: ${f.name} (${ext}, ${Math.round(f.size/1024)}KB)`, 'info');
    render();
    try {
      if (ext === 'pdf')                                       await doPDF(id, f);
      else if (['txt','csv','md','html','htm'].includes(ext))  await doText(id, f);
      else if (['jpg','jpeg','png'].includes(ext))             await doImg(id, f);
      else throw new Error('Format non supportÃ©: ' + ext);
      docs[id].status = 'ready';
      log(`âœ“ PrÃªt. ${docs[id].text.length} chars: "${docs[id].text.slice(0,120).replace(/\n/g,' ')}"`, 'ok');
    } catch(e) {
      docs[id].status = 'error';
      log(`âœ— ERREUR: ${e.message}`, 'err');
    }
    render();
    search();
  }
}

// â”€â”€ fixSpacedText â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fixSpacedText(text) {
  const tokens = text.split(' ');
  const out = [];
  let run = [];
  const flush = () => {
    if (run.length >= 2) out.push(run.join(''));
    else if (run.length === 1) out.push(run[0]);
    run = [];
  };
  for (const tok of tokens) {
    if (tok.length === 1) { run.push(tok); }
    else { flush(); if (tok.length > 0) out.push(tok); }
  }
  flush();
  return out.join(' ');
}

// â”€â”€ PDF â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function doPDF(id, file) {
  setP(id, 5, 'lecture PDFâ€¦');
  const buf = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({ data: buf }).promise;
  log(`PDF: ${pdf.numPages} page(s)`, 'info');
  const pages = []; let full = '';
  for (let p = 1; p <= pdf.numPages; p++) {
    setP(id, 5 + Math.round(p / pdf.numPages * 90), `page ${p}/${pdf.numPages}`);
    const pg      = await pdf.getPage(p);
    const content = await pg.getTextContent();
    let pageText = '', lastY = null;
    for (const item of content.items) {
      if (lastY !== null && Math.abs(item.transform[5] - lastY) > 5) pageText += ' ';
      pageText += item.str;
      if (item.hasEOL) pageText += ' ';
      lastY = item.transform[5];
    }
    pageText = fixSpacedText(pageText.replace(/\s+/g, ' ').trim());
    log(`  p.${p}: "${pageText.slice(0,80)}" (${pageText.length} chars)`, '');
    pages.push({ page: p, text: pageText });
    full += ' ' + pageText;
  }
  full = full.replace(/\s+/g, ' ').trim();
  log(`Texte total PDF: ${full.length} chars`, full.length > 50 ? 'ok' : 'err');
  docs[id].pages = pages;
  docs[id].text  = full;
}

// â”€â”€ Image OCR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function doImg(id, file) {
  setP(id, 20, 'envoi OCRâ€¦');
  log(`Image: envoi Ã  OCR.spaceâ€¦`, 'info');
  const b64 = await new Promise((res, rej) => {
    const r = new FileReader();
    r.onload = () => res(r.result);
    r.onerror = rej;
    r.readAsDataURL(file);
  });
  const fd = new FormData();
  fd.append('base64Image', b64);
  fd.append('language', 'fre');
  fd.append('isOverlayRequired', 'false');
  fd.append('OCREngine', '2');
  fd.append('detectOrientation', 'true');
  const resp = await fetch('https://api.ocr.space/parse/image', {
    method: 'POST',
    headers: { 'apikey': 'K81910290488957' },
    body: fd
  });
  log(`OCR.space HTTP: ${resp.status}`, resp.ok ? 'ok' : 'err');
  if (!resp.ok) throw new Error(`OCR HTTP ${resp.status}`);
  const data = await resp.json();
  if (data.IsErroredOnProcessing) throw new Error(data.ErrorMessage?.[0] || 'OCR error');
  const txt = (data.ParsedResults || []).map(r => r.ParsedText || '').join('\n');
  log(`OCR rÃ©sultat: "${txt.slice(0,100)}"`, txt.length > 10 ? 'ok' : 'err');
  docs[id].pages = [{ page: 1, text: txt }];
  docs[id].text  = txt;
}

// â”€â”€ Text â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function doText(id, file) {
  const t = await file.text();
  docs[id].pages = [{ page: 1, text: t }];
  docs[id].text  = t;
}

// â”€â”€ Progress â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setP(id, pct, lbl) {
  if (!docs[id]) return;
  docs[id].prog = pct; docs[id].plbl = lbl;
  const f = document.querySelector(`[data-id="${id}"] .fpf`);
  const l = document.querySelector(`[data-id="${id}"] .fpl`);
  if (f) f.style.width = pct + '%';
  if (l) l.textContent = lbl;
}

// â”€â”€ Clear all â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function clearAll() {
  Object.keys(docs).forEach(id => delete docs[id]);
  render();
  search();
}

// â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function render() {
  const ids   = Object.keys(docs);
  const ready = ids.filter(i => docs[i].status === 'ready').length;
  const hdr   = document.getElementById('files-header');
  const cnt   = document.getElementById('files-count');

  if (ids.length) {
    hdr.style.display = 'flex';
    cnt.textContent = `${ids.length} document${ids.length > 1 ? 's' : ''} Â· ${ready} indexÃ©${ready > 1 ? 's' : ''}`;
  } else {
    hdr.style.display = 'none';
  }

  document.getElementById('flist').innerHTML = ids.map(id => {
    const d  = docs[id];
    const ic = d.status === 'loading' ? '<span class="spin"></span>' : d.status === 'ready' ? 'âœ“' : 'âœ—';
    const lb = d.status === 'loading' ? d.plbl : d.status === 'ready' ? 'prÃªt' : 'erreur';
    const pb = d.status === 'loading'
      ? `<div class="fpw" data-id="${id}"><div class="fpb"><div class="fpf" style="width:${d.prog}%"></div></div><div class="fpl">${d.plbl}</div></div>` : '';
    return `<div class="fi ${d.status}" data-id="${id}">
      <span class="fext">${d.ext}</span>
      <span class="fn" title="${d.name}">${d.name}</span>
      <span class="fs ${d.status}">${ic} ${lb}</span>
      <button class="fdel" onclick="rm(${id})" title="Supprimer">âœ•</button>
    </div>${pb}`;
  }).join('');
}

function rm(id) { delete docs[id]; render(); search(); }

// â”€â”€ Search â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('q').addEventListener('input', () => { clearTimeout(stmo); stmo = setTimeout(search, 80); });

function search() {
  const q      = document.getElementById('q').value.trim();
  const res    = document.getElementById('res');
  const rh     = document.getElementById('res-header');
  const statsEl = document.getElementById('stats');
  const all    = Object.keys(docs);
  const ids    = all.filter(i => docs[i].status === 'ready');

  if (!all.length) {
    rh.style.display = 'none';
    res.innerHTML = '<div class="empty"><div class="eico">?</div>IMPORTEZ DES DOCUMENTS PUIS TAPEZ POUR CHERCHER</div>';
    return;
  }
  if (!q) {
    rh.style.display = 'none';
    res.innerHTML = '<div class="empty"><div class="eico">âŒ•</div>TAPEZ UN MOT OU UNE EXPRESSION</div>';
    return;
  }

  const re    = new RegExp(esc(q), 'gi');
  const cards = ids.map(id => {
    const d = docs[id];
    const n = (d.text.match(re) || []).length;
    log(`"${q}" dans ${d.name}: ${n}`, n > 0 ? 'ok' : '');
    return { d, n, snips: snip(d, q) };
  }).filter(c => c.n > 0)   // â† on n'affiche QUE les rÃ©sultats trouvÃ©s
    .sort((a, b) => b.n - a.n);

  const tot  = cards.reduce((s, c) => s + c.n, 0);

  if (cards.length === 0) {
    rh.style.display = 'none';
    res.innerHTML = `<div class="empty"><div class="eico">âœ—</div>AUCUN RÃ‰SULTAT POUR Â« ${q} Â»</div>`;
    return;
  }

  rh.style.display = 'flex';
  statsEl.innerHTML = `<b>${tot}</b> occurrence${tot > 1 ? 's' : ''} dans <b>${cards.length}</b> doc${cards.length > 1 ? 's' : ''}`;

  res.innerHTML = cards.map(({ d, n, snips }) => {
    const sh = snips.map(s =>
      `<div class="sn"><div class="snp">${s.l}</div>${s.h}</div>`
    ).join('');
    return `<div class="rc hit">
      <div class="rh">
        <span class="fext">${d.ext}</span>
        <span class="rn">${d.name}</span>
        <span class="rk">${n} rÃ©sultat${n > 1 ? 's' : ''}</span>
      </div>
      ${sh ? `<div class="rss">${sh}</div>` : ''}
    </div>`;
  }).join('');
}

function snip(doc, q) {
  const re = new RegExp(esc(q), 'gi'), out = [];
  for (const pg of doc.pages) {
    let m; re.lastIndex = 0;
    while ((m = re.exec(pg.text)) !== null && out.length < 3) {
      const s = Math.max(0, m.index - 80), e = Math.min(pg.text.length, m.index + q.length + 80);
      let x = pg.text.slice(s, e).replace(/\s+/g, ' ').trim();
      if (s > 0) x = 'â€¦' + x; if (e < pg.text.length) x += 'â€¦';
      const h = x.replace(new RegExp(esc(q), 'gi'), v => `<mark>${v}</mark>`);
      out.push({ l: doc.pages.length > 1 ? `page ${pg.page}` : 'extrait', h });
    }
  }
  return out;
}

function esc(s) { return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }
</script>
</body>
</html>
